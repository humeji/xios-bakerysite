# Example GitHub Actions workflow for security scanning
# Rename to security.yml to activate

name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Semgrep Security Scan
      uses: semgrep/semgrep-action@v1
      with:
        config: auto
        generateSarif: "1"
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: semgrep.sarif
      if: always()
    
    - name: ESLint Security Scan
      run: |
        npm install -g eslint eslint-plugin-security
        npx eslint themes/*/assets/*.js --config .eslintrc-security.json --format json --output-file eslint-results.json || true
    
    - name: Check for Critical Vulnerabilities
      run: |
        # Fail the build if critical vulnerabilities are found
        if grep -q '"severity":"error"' eslint-results.json; then
          echo "❌ Critical security vulnerabilities found!"
          exit 1
        else
          echo "✅ No critical security issues detected"
        fi

  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'xios-bakery-theme'
        path: '.'
        format: 'SARIF'
        
    - name: Upload Dependency Check results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: reports/dependency-check-report.sarif
